<div class="property-detail" *ngIf="property">
  <div class="back-nav">
    <button class="btn btn-secondary" (click)="goBack()">
      ‚Üê {{ isOwner ? 'Retour √† mes propri√©t√©s' : 'Retour aux propri√©t√©s' }}
    </button>
  </div>

  <div class="property-header">
    <h1>{{ property.title }}</h1>
    <p class="location">üìç {{ property.location }}</p>
    <span *ngIf="isOwner" class="owner-badge">üè† Votre propri√©t√©</span>
  </div>

  <div class="property-content">
    <!-- Image de la propri√©t√© -->
    <div class="property-images">
      <img [src]="getPropertyImage(property.id)" [alt]="property.title" class="main-image">
    </div>

    <div class="property-info">
      <!-- Description -->
      <div class="description-section">
        <h3>Description</h3>
        <p>{{ property.description || 'Aucune description disponible' }}</p>
      </div>

      <!-- D√©tails de la propri√©t√© (Mode lecture) -->
      <div class="details-section" *ngIf="!editMode">
        <h3>D√©tails</h3>
        <div class="detail-item">
          <span class="label">Prix par jour:</span>
          <span class="value">{{ property.pricePerDay }} ETH</span>
        </div>
        <div class="detail-item">
          <span class="label">D√©p√¥t de garantie:</span>
          <span class="value">{{ property.deposit }} ETH</span>
        </div>
        <div class="detail-item">
          <span class="label">Propri√©taire:</span>
          <span class="value">{{ formatAddress(property.owner) }}</span>
        </div>
        <div class="detail-item">
          <span class="label">Statut:</span>
          <span class="value" [class.available]="property.isAvailable"
                [class.unavailable]="!property.isAvailable">
            {{ property.isAvailable ? '‚úÖ Disponible' : '‚ùå Occup√©e' }}
          </span>
        </div>
      </div>

      <!-- Contact du propri√©taire (pour non-propri√©taires) -->
      <div class="owner-contact-section" *ngIf="!isOwner && isConnected">
        <h3>üìû Contacter le propri√©taire</h3>
        
        <div *ngIf="loadingOwner" class="loading-owner">
          <p>Chargement des informations...</p>
        </div>

        <div *ngIf="!loadingOwner && ownerInfo && (ownerInfo.username || ownerInfo.email || ownerInfo.phone)" class="owner-contact-info">
          <div class="contact-item" *ngIf="ownerInfo.username">
            <span class="contact-icon">üë§</span>
            <span class="contact-value">{{ ownerInfo.username }}</span>
          </div>
          <div class="contact-item" *ngIf="ownerInfo.email">
            <span class="contact-icon">üìß</span>
            <a href="mailto:{{ ownerInfo.email }}" class="contact-value contact-link">{{ ownerInfo.email }}</a>
          </div>
          <div class="contact-item" *ngIf="ownerInfo.phone">
            <span class="contact-icon">üì±</span>
            <a href="tel:{{ ownerInfo.phone }}" class="contact-value contact-link">{{ ownerInfo.phone }}</a>
          </div>
        </div>

        <div *ngIf="!loadingOwner && (!ownerInfo || (!ownerInfo.username && !ownerInfo.email && !ownerInfo.phone))" class="no-contact-info">
          <p>üòï Ce propri√©taire n'a pas encore renseign√© ses coordonn√©es.</p>
          <p class="hint">Wallet: {{ formatAddress(property.owner) }}</p>
        </div>
      </div>

      <!-- ========== VUE PROPRI√âTAIRE ========== -->
      <div *ngIf="isOwner" class="owner-section">

        <!-- Bouton Modifier -->
        <div class="owner-actions">
          <button class="btn btn-secondary" (click)="toggleEditMode()">
            {{ editMode ? '‚ùå Annuler' : '‚úèÔ∏è Modifier les d√©tails' }}
          </button>
        </div>

        <!-- Formulaire de modification -->
        <div *ngIf="editMode" class="edit-form">
          <h3>‚úèÔ∏è Modifier la propri√©t√©</h3>

          <div class="form-group">
            <label>Titre</label>
            <input type="text" [(ngModel)]="editData.title" class="form-control">
          </div>

          <div class="form-group">
            <label>Description</label>
            <textarea [(ngModel)]="editData.description" class="form-control" rows="3"></textarea>
          </div>

          <div class="form-group">
            <label>Localisation</label>
            <input type="text" [(ngModel)]="editData.location" class="form-control">
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Prix par jour (ETH)</label>
              <input type="number" [(ngModel)]="editData.pricePerDay" class="form-control" step="0.001">
            </div>

            <div class="form-group">
              <label>D√©p√¥t de garantie (ETH)</label>
              <input type="number" [(ngModel)]="editData.deposit" class="form-control" step="0.001">
            </div>
          </div>

          <button class="btn btn-primary" (click)="saveChanges()">
            üíæ Sauvegarder les modifications
          </button>
        </div>

        <!-- Section R√©servations -->
        <div class="bookings-section" *ngIf="!editMode">
          <h3>üìÖ R√©servations de cette propri√©t√©</h3>

          <!-- Formulaire de blocage de dates -->
          <div class="block-dates-form">
            <h4>üîí Bloquer des dates</h4>
            <p class="form-hint">Bloquez des dates pour votre usage personnel</p>

            <div class="form-row">
              <div class="form-group">
                <label>Date d√©but</label>
                <input type="date"
                       [(ngModel)]="blockData.startDate"
                       [min]="getMinStartDate()"
                       class="form-control">
              </div>
              <div class="form-group">
                <label>Date fin</label>
                <input type="date"
                       [(ngModel)]="blockData.endDate"
                       [min]="blockData.startDate || getMinStartDate()"
                       class="form-control">
              </div>
              <div class="form-group form-action">
                <button class="btn btn-secondary"
                        (click)="blockDates()"
                        [disabled]="!canBlockDates() || processingBlock">
                  {{ processingBlock ? '‚è≥...' : 'üîí Bloquer' }}
                </button>
              </div>
            </div>
          </div>

          <div *ngIf="loadingBookings" class="loading-bookings">
            <p>Chargement des r√©servations...</p>
          </div>

          <div *ngIf="!loadingBookings && bookings.length === 0" class="no-bookings">
            <div class="empty-bookings">
              <span class="empty-icon">üì≠</span>
              <p>Aucune r√©servation pour cette propri√©t√©</p>
            </div>
          </div>

          <div *ngIf="!loadingBookings && bookings.length > 0" class="bookings-list">
            <div class="bookings-summary">
              <div class="summary-item">
                <span class="summary-value">{{ bookings.length }}</span>
                <span class="summary-label">Total</span>
              </div>
              <div class="summary-item">
                <span class="summary-value">{{ getActiveBookingsCount() }}</span>
                <span class="summary-label">Active(s)</span>
              </div>
              <div class="summary-item">
                <span class="summary-value">{{ getCompletedBookingsCount() }}</span>
                <span class="summary-label">Termin√©e(s)</span>
              </div>
            </div>

            <div *ngFor="let booking of bookings" class="booking-card" [class]="getBookingStatusClass(booking)">
              <div class="booking-header">
                <span class="booking-id">
                  {{ isOwnerBooking(booking) ? 'üîí Blocage' : 'Location' }} #{{ booking.id }}
                </span>
                <span class="booking-status" [class]="getBookingStatusClass(booking)">
                  {{ getBookingStatusText(booking) }}
                </span>
              </div>

              <div class="booking-dates">
                <div class="date-item">
                  <span class="date-label">üìÖ Arriv√©e</span>
                  <span class="date-value">{{ formatDate(booking.startDate) }}</span>
                </div>
                <span class="date-arrow">‚Üí</span>
                <div class="date-item">
                  <span class="date-label">üìÖ D√©part</span>
                  <span class="date-value">{{ formatDate(booking.endDate) }}</span>
                </div>
              </div>

              <div class="booking-details">
                <div class="detail" *ngIf="!isOwnerBooking(booking)">
                  <span class="detail-label">Locataire:</span>
                  <span class="detail-value">{{ formatAddress(booking.tenant) }}</span>
                </div>
                <div class="detail">
                  <span class="detail-label">Montant:</span>
                  <span class="detail-value">{{ booking.totalPrice }} ETH</span>
                </div>
                <div class="detail">
                  <span class="detail-label">D√©p√¥t:</span>
                  <span class="detail-value">{{ booking.deposit }} ETH</span>
                </div>
              </div>

              <!-- Bouton annuler pour le propri√©taire -->
              <div class="booking-actions" *ngIf="booking.isActive">
                <button class="btn btn-danger btn-sm"
                        (click)="cancelBooking(booking.id)"
                        [disabled]="processingCancel === booking.id">
                  {{ processingCancel === booking.id ? '‚è≥...' : '‚ùå Annuler' }}
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ========== VUE LOCATAIRE ========== -->

      <!-- Formulaire de location (seulement pour non-propri√©taires) -->
      <div class="rental-form" *ngIf="!isOwner && property.isAvailable && isConnected">
        <h3>üìÖ R√©server cette propri√©t√©</h3>

        <form (ngSubmit)="onRentSubmit()" #rentalForm="ngForm">
          <div class="form-group">
            <label for="startDate">Date d'arriv√©e *</label>
            <input type="date" id="startDate"
                   [(ngModel)]="rentalData.startDate"
                   name="startDate"
                   required
                   [min]="getMinStartDate()"
                   (change)="calculateTotal()"
                   class="form-control">
            <small>√Ä partir de demain</small>
          </div>

          <div class="form-group">
            <label for="endDate">Date de d√©part *</label>
            <input type="date" id="endDate"
                   [(ngModel)]="rentalData.endDate"
                   name="endDate"
                   required
                   [min]="getMinEndDate()"
                   (change)="calculateTotal()"
                   class="form-control">
            <small>Au moins 1 nuit</small>
          </div>

          <!-- Calcul du prix -->
          <div class="price-calculation" *ngIf="rentalData.totalPrice > 0">
            <h4>üí∞ D√©tail du prix</h4>
            <div class="calculation-item">
              <span>Prix du s√©jour ({{ calculateDays() }} jours):</span>
              <span>{{ rentalData.totalPrice }} ETH</span>
            </div>
            <div class="calculation-item">
              <span>D√©p√¥t de garantie:</span>
              <span>{{ property.deposit }} ETH</span>
            </div>
            <div class="calculation-item total">
              <span><strong>Montant total √† payer:</strong></span>
              <span><strong>{{ rentalData.totalPrice + property.deposit }} ETH</strong></span>
            </div>
          </div>

          <!-- Message d'erreur -->
          <div *ngIf="error" class="error-message">
            ‚ùå {{ error }}
          </div>

          <button type="submit"
                  class="btn btn-primary rent-btn"
                  [disabled]="!canRent() || processing">
            {{ processing ? '‚è≥ Traitement...' : '‚úÖ Confirmer la location' }}
          </button>
        </form>
      </div>

      <!-- Message si non connect√© -->
      <div *ngIf="!isConnected" class="connect-warning">
        <h4>üîó Connexion requise</h4>
        <p>Veuillez connecter votre wallet MetaMask pour voir les d√©tails</p>
      </div>

      <!-- Message si propri√©taire essaie de louer -->
      <div *ngIf="isOwner && !editMode" class="owner-info">
        <h4>‚ÑπÔ∏è Information</h4>
        <p>Vous √™tes le propri√©taire de ce bien. Vous pouvez voir les r√©servations ci-dessus.</p>
      </div>

      <!-- Message si propri√©t√© occup√©e (pour non-propri√©taires) -->
      <div *ngIf="!isOwner && !property.isAvailable && isConnected" class="unavailable-warning">
        <h4>‚ùå Non disponible</h4>
        <p>Cette propri√©t√© est actuellement occup√©e</p>
      </div>
    </div>
  </div>
</div>

<!-- Loading state -->
<div *ngIf="loading" class="loading">
  <p>Chargement de la propri√©t√©...</p>
</div>

<!-- Error state -->
<div *ngIf="!property && !loading" class="not-found">
  <h3>Propri√©t√© non trouv√©e</h3>
  <button class="btn btn-secondary" (click)="goBack()">Retour aux propri√©t√©s</button>
</div>